# 文件夾選擇功能使用指南

## 🎯 功能概述

文件夾選擇功能允許您在動態 RAG 模式下限制搜索範圍到特定的文件夾，提高搜索精準度並減少 CUDA 記憶體使用。

## 🚀 使用方法

### 1. 啟用文件夾選擇

1. 在前端選擇 **"Dynamic RAG"** 模式
2. 在側邊欄找到 **"📁 搜索範圍"** 區域
3. 勾選 **"限制搜索範圍"** 選項

### 2. 多層級文件夾導航

#### 📍 導航欄功能
- **當前位置顯示**：顯示完整的路徑導航
- **⬆️ 上級按鈕**：返回上一級目錄
- **🏠 根目錄按鈕**：直接返回根目錄

#### 📊 統計信息
- **📁 文件夾數**：當前目錄下的子文件夾數量
- **📄 文件數**：當前目錄下支持的文件數量
- **💾 總大小**：所有文件的總大小（MB/GB）
- **📊 平均大小**：每個文件的平均大小

#### 📂 文件夾操作
- **📂 進入**：進入子文件夾繼續瀏覽
- **✅ 選擇**：選擇該文件夾作為搜索範圍
- **❌ 無文件**：文件夾為空或沒有支持的文件

### 3. 選擇搜索範圍

#### 選擇當前目錄
- 點擊 **"✅ 選擇"** 按鈕選擇當前目錄
- 系統會顯示將要搜索的文件數量和總大小

#### 選擇子文件夾
- 瀏覽到想要的文件夾
- 點擊該文件夾的 **"✅ 選擇"** 按鈕
- 確認選擇後開始查詢

#### 清除選擇
- 點擊 **"🗑️ 清除選擇"** 按鈕
- 返回全局搜索模式

## 📋 支持的文件類型

系統支持以下文件類型：
- 📄 PDF 文件 (`.pdf`)
- 📝 Word 文檔 (`.docx`, `.doc`)
- 📊 Excel 表格 (`.xlsx`, `.xls`)
- 📋 文本文件 (`.txt`, `.md`)
- 🎯 PowerPoint (`.pptx`, `.ppt`)
- 📈 CSV 文件 (`.csv`)
- 🎨 Visio 圖表 (`.vsdx`, `.vsd`)

## 🎯 使用場景

### 1. 精準搜索
當您知道相關文檔在特定部門或項目文件夾中時：
```
例如：搜索 "IT部門/系統文檔" 文件夾中的技術規範
```

### 2. 大量文件優化
當根目錄文件過多導致記憶體不足時：
```
選擇具體的子文件夾可以大幅減少記憶體使用
```

### 3. 主題相關搜索
按業務領域或項目分類搜索：
```
例如：只在 "財務部門" 文件夾中搜索預算相關問題
```

## ⚡ 性能優化

### 記憶體使用優化
- **全局搜索**：可能掃描數千個文件
- **文件夾限制**：只掃描選定範圍內的文件
- **記憶體節省**：可減少 50-90% 的 CUDA 記憶體使用

### 搜索速度提升
- **減少掃描時間**：只處理相關文件夾
- **提高精準度**：減少無關文檔的干擾
- **快速響應**：特別是在大型文檔庫中

## 🔧 技術細節

### API 端點
- `GET /api/folders` - 獲取根目錄文件夾列表
- `GET /api/folders?path=xxx` - 獲取指定路徑的子文件夾

### 返回數據格式
```json
{
  "current_path": "部門/IT部門",
  "parent_path": "部門",
  "path_parts": [
    {"name": "部門", "path": "部門"},
    {"name": "IT部門", "path": "部門/IT部門"}
  ],
  "folders": [
    {
      "name": "系統文檔",
      "path": "部門/IT部門/系統文檔",
      "files_count": 45,
      "total_size": 125829120,
      "size_mb": 120.0
    }
  ],
  "files_count": 12,
  "total_size": 25165824,
  "size_mb": 24.0,
  "total_folders": 3
}
```

### 安全限制
- 路徑必須在 Q 槽範圍內
- 自動過濾不支持的文件類型
- 限制文件統計數量避免性能問題

## 🐛 故障排除

### 常見問題

#### 1. 無法獲取文件夾列表
**原因**：網路連接問題或 API 服務異常
**解決**：
- 檢查 API 服務是否正常運行
- 確認網路連接穩定
- 重新整理頁面

#### 2. 文件夾顯示為空
**原因**：文件夾中沒有支持的文件類型
**解決**：
- 檢查文件夾中是否有支持的文件格式
- 確認文件權限是否正確

#### 3. 統計信息不準確
**原因**：大量文件時會限制統計數量
**解決**：
- 這是正常的性能優化行為
- 實際搜索時會處理所有文件

#### 4. 記憶體仍然不足
**原因**：選擇的文件夾仍然包含大量文件
**解決**：
- 選擇更小的子文件夾
- 檢查 `.env` 配置中的批處理大小設置
- 考慮進一步降低 `EMBEDDING_BATCH_SIZE`

## 📈 最佳實踐

### 1. 合理選擇範圍
- 根據問題類型選擇相關的部門或項目文件夾
- 避免選擇過大的文件夾範圍
- 優先選擇文件數量在 100-500 個的文件夾

### 2. 利用統計信息
- 查看文件數量和大小來評估搜索範圍
- 選擇文件數量適中的文件夾
- 注意總大小，避免選擇過大的文件夾

### 3. 分層搜索策略
- 先在大範圍內搜索獲得概覽
- 根據結果縮小到具體的子文件夾
- 利用多次搜索逐步精確定位

### 4. 記憶體管理
- 定期清除選擇重新開始
- 在大量文件環境中優先使用文件夾限制
- 監控系統記憶體使用情況

## 🎉 總結

文件夾選擇功能是動態 RAG 系統的重要增強，它不僅提高了搜索的精準度，還有效解決了大量文件導致的記憶體問題。通過合理使用這個功能，您可以：

- ✅ 提高搜索精準度
- ✅ 減少 CUDA 記憶體使用
- ✅ 加快搜索響應速度
- ✅ 獲得更相關的搜索結果

建議在處理大型文檔庫時優先使用此功能！