# 向量資料庫維護功能

## 概述

本系統新增了向量資料庫維護介面，提供完整的向量資料庫管理功能，包括查看、備份、刪除和統計等操作。所有維護功能都受到管理者token保護，確保系統安全。

## 功能特色

### 🔐 安全保護
- 所有維護功能都需要管理者token驗證
- Token配置在環境變數 `ADMIN_TOKEN` 中（預設：`ragadmin123`）
- 未授權用戶無法存取任何維護功能

### 📊 資料庫概覽
- 顯示總模型數、有數據模型數、訓練中模型數、可用模型數
- 即時統計資訊，幫助管理員快速了解系統狀態

### 🔧 模型管理
每個向量模型提供以下管理功能：
- **詳細信息查看**：文件夾大小、文件數量、關鍵文件狀態
- **備份功能**：創建完整的模型備份，包含時間戳
- **刪除功能**：安全刪除模型（需二次確認）
- **狀態監控**：實時顯示訓練狀態和數據狀態

### 🔄 批量操作
- **清理空資料夾**：自動清理沒有向量數據的空資料夾
- **統計資訊**：詳細的系統統計，包括各模型大小和狀態
- **完整性檢查**：檢查所有模型的文件完整性和配置正確性

## 使用方式

### 1. 前端介面
在Streamlit前端中，選擇「🗄️ 向量資料庫維護」分頁：

1. 輸入管理員Token
2. 查看資料庫概覽統計
3. 管理個別模型：
   - 點擊模型展開詳細信息
   - 使用「📋 詳細信息」查看完整資訊
   - 使用「💾 備份」創建備份
   - 使用「🗑️ 刪除」刪除模型（需確認）
4. 執行批量操作：
   - 清理空資料夾
   - 查看統計資訊
   - 執行完整性檢查

### 2. API端點
所有API端點都需要在請求標頭中包含 `admin_token`：

#### 基本信息
- `GET /api/vector-models` - 獲取所有向量模型列表
- `GET /admin/vector-db/info?folder_name={name}` - 獲取指定模型詳細信息
- `GET /admin/vector-db/stats` - 獲取統計信息

#### 維護操作
- `POST /admin/vector-db/backup` - 備份指定模型
- `DELETE /admin/vector-db/delete` - 刪除指定模型
- `POST /admin/vector-db/cleanup-empty` - 清理空資料夾
- `GET /admin/vector-db/integrity-check` - 完整性檢查

## 備份機制

### 備份位置
- 備份文件存放在 `./backups/` 目錄
- 備份文件夾命名格式：`{模型名稱}_backup_{時間戳}`
- 例如：`ollama@qwen2_0.5b-instruct@nomic-embed-text_latest#20250731_backup_20250808_104500`

### 備份內容
- 完整的向量資料庫文件（index.faiss, index.pkl）
- 模型配置文件（.model）
- 備份信息文件（.backup_info）包含：
  - 原始模型信息
  - 備份時間
  - 備份大小
  - 模型配置

### 備份恢復
目前備份為手動恢復，管理員可以：
1. 找到對應的備份資料夾
2. 將備份內容複製回 `vector_db/` 目錄
3. 重新啟動相關服務

## 安全考量

### 權限控制
- 所有維護功能都需要正確的管理員token
- 刪除操作需要二次確認
- 訓練中的模型無法被刪除

### 數據保護
- 刪除前建議先備份
- 系統會檢查模型是否正在使用中
- 提供完整性檢查確保數據一致性

### 日誌記錄
- 所有維護操作都會記錄在系統日誌中
- 包含操作時間、操作者、操作內容
- 便於審計和問題追蹤

## 故障排除

### 常見問題

1. **無法存取維護功能**
   - 檢查管理員token是否正確
   - 確認環境變數 `ADMIN_TOKEN` 設置

2. **備份失敗**
   - 檢查 `backups/` 目錄是否存在且可寫
   - 確認磁碟空間充足
   - 檢查模型資料夾是否存在

3. **刪除失敗**
   - 確認模型沒有在訓練中
   - 檢查文件權限
   - 確認沒有其他程序正在使用該模型

4. **完整性檢查失敗**
   - 檢查向量資料庫文件是否完整
   - 確認 `.model` 配置文件正確
   - 檢查鎖定文件狀態

### 日誌查看
- 系統日誌位於 `logs/` 目錄
- API操作日誌：`logs/app.log`
- 訓練日誌：`logs/indexing.log`

## 最佳實踐

1. **定期備份**：建議定期備份重要的向量模型
2. **監控空間**：定期清理空資料夾和舊備份
3. **完整性檢查**：定期執行完整性檢查確保數據一致性
4. **權限管理**：妥善保管管理員token，避免洩露
5. **操作記錄**：重要操作前記錄當前狀態，便於回滾

## 技術實現

### 後端架構
- 使用 FastAPI 提供 RESTful API
- 向量資料庫管理器 (`VectorDBManager`) 統一管理
- 權限中間件確保安全性

### 前端架構
- Streamlit 提供直觀的Web介面
- 分頁設計，獨立的維護介面
- 即時狀態更新和操作反饋

### 數據結構
- 向量模型以資料夾形式組織
- `.model` 文件記錄模型元數據
- `.lock` 文件管理訓練狀態
- 標準化的命名規則便於管理

## 更新日誌

### v1.0.0 (2025-08-08)
- 新增向量資料庫維護介面
- 實現模型查看、備份、刪除功能
- 添加批量操作和完整性檢查
- 完整的權限控制和安全保護